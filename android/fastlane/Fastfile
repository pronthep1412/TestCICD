# android/fastlane/Fastfile - Fixed version management
default_platform(:android)

platform :android do
  
  before_all do
    ensure_bundle_exec
    
    # ‚úÖ Apply version from ENV (like Flutter)
    apply_version_from_env if ENV['CI']
  end

  private_lane :apply_version_from_env do
    version_name = ENV['VERSION_NAME'] || "1.0.0"
    version_code = ENV['VERSION_CODE'] || "1"
    
    UI.message("üìã Applying version from GitHub Actions workflow:")
    UI.message("   versionName: #{version_name}")
    UI.message("   versionCode: #{version_code}")
    UI.message("   Source: GitHub Actions (#{ENV['GITHUB_REF_NAME']})")
    
    gradle_file = "../app/build.gradle"
    
    # Update build.gradle
    sh("sed -i 's/versionName \".*\"/versionName \"#{version_name}\"/' #{gradle_file}")
    sh("sed -i 's/versionCode [0-9]*/versionCode #{version_code}/' #{gradle_file}")
    
    # Verify update
    gradle_content = File.read(gradle_file)
    actual_name = gradle_content.match(/versionName "([^"]+)"/)[1]
    actual_code = gradle_content.match(/versionCode (\d+)/)[1]
    
    UI.success("‚úÖ Applied to build.gradle:")
    UI.success("   versionName \"#{actual_name}\"")
    UI.success("   versionCode #{actual_code}")
  end

  # üöÄ Deployment lanes (‡πÄ‡∏î‡∏¥‡∏° + ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)
  lane :deploy_develop do
    UI.message("üöÄ Deploying to Internal Testing...")
    build_and_deploy(
      track: 'internal',
      release_status: 'draft'
    )
    # notify_slack("üöÄ Android Development build deployed to Internal Testing!")
  end

  lane :deploy_preprod do
    UI.message("üöÄ Deploying to Alpha Testing...")
    build_and_deploy(
      track: 'alpha',
      release_status: 'draft'
    )
    # notify_slack("üöÄ Android Pre-production build deployed to Alpha!")
  end

  lane :deploy_master do
    UI.message("üéâ Deploying to Production...")
    build_and_deploy(
      track: 'production',
      release_status: 'draft',
      rollout: '0.1'  # 10% rollout for safety
    )
    # notify_slack("üéâ Android Production build deployed with 10% rollout!")
  end

  lane :build_only do
    UI.message("üî® Building release bundle...")
    gradle(
      task: "clean bundleRelease",
      print_command: false
    )
    UI.success("‚úÖ Build completed successfully!")
  end

  # üîß Private lanes
  private_lane :build_and_deploy do |options|
    # Clean ‡πÅ‡∏•‡∏∞ build
    gradle(
      task: "clean bundleRelease",
      print_command: false
    )
    
    # Upload to Play Store
    upload_to_play_store(
      track: options[:track],
      json_key: "google-play-key.json",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      release_status: options[:release_status],
      rollout: options[:rollout],
      package_name: "test.cicd.appibc",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      timeout: 300
    )
    
    UI.success("‚úÖ Successfully uploaded to #{options[:track]} track!")
  end

  private_lane :notify_slack do |message|
    return unless ENV["SLACK_URL"]
    
    begin
      slack(
        message: message,
        channel: "#releases",
        webhook_url: ENV["SLACK_URL"],
        username: "Android CI/CD",
        icon_emoji: ":robot_face:"
      )
    rescue => e
      UI.error("Failed to send Slack notification: #{e.message}")
    end
  end

  # Error handling
  error do |lane, exception|
    error_message = "‚ùå Android deployment failed in lane '#{lane}': #{exception.message}"
    UI.error(error_message)
    # notify_slack(error_message) if defined?(notify_slack)
    raise exception
  end
end