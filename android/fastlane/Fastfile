# android/fastlane/Fastfile - Improved version
default_platform(:android)

platform :android do
  
  before_all do
    ensure_bundle_exec
  end

  # Lane สำหรับ develop branch
  lane :deploy_develop do
    build_and_deploy(
      track: 'internal',
      release_status: 'completed'
    )
    
    notify_slack("🚀 Android Development build deployed to Internal Testing!")
  end

  # Lane สำหรับ preprod branch  
  lane :deploy_preprod do
    build_and_deploy(
      track: 'alpha',
      release_status: 'completed'
    )
    
    notify_slack("🚀 Android Pre-production build deployed to Alpha!")
  end

  # Lane สำหรับ master branch (Production)
  lane :deploy_master do
    build_and_deploy(
      track: 'production',
      release_status: 'completed',
      rollout: '0.1'  # 10% rollout
    )
    
    notify_slack("🎉 Android Production build deployed with 10% rollout!")
  end

  # Lane สำหรับ build เฉยๆ
  lane :build_only do
    gradle(
      task: "bundle",
      build_type: "Release"
    )
  end

  # Private lanes
  private_lane :build_and_deploy do |options|
    gradle(
      task: "bundle",
      build_type: "Release"
    )
    
    upload_to_play_store(
      track: options[:track],
      json_key: "google-play-key.json",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      release_status: options[:release_status],
      rollout: options[:rollout],
      package_name: "test.cicd.appibc"
    )
  end

  private_lane :notify_slack do |message|
    if ENV["SLACK_URL"]
      slack(
        message: message,
        channel: "#releases"
      )
    end
  end

  # Error handling
  error do |lane, exception|
    notify_slack("❌ Android deployment failed in lane '#{lane}': #{exception.message}")
  end
end