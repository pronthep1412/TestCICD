# android/fastlane/Fastfile - Optimized Version
default_platform(:android)

platform :android do
  
  #Setup à¹à¸¥à¸° Configuration
  before_all do
    ensure_bundle_exec
    apply_version_from_env if ENV['CI']
  end

  #Version Management
  private_lane :apply_version_from_env do
    version_name = ENV['VERSION_NAME'] || "1.0.0"
    version_code = ENV['VERSION_CODE'] || "1"
    
    UI.message("ğŸ“‹ Applying version from GitHub Actions workflow:")
    UI.message("   versionName: #{version_name}")
    UI.message("   versionCode: #{version_code}")
    UI.message("   Source: GitHub Actions (#{ENV['GITHUB_REF_NAME']})")
    
    # âœ… à¹ƒà¸Šà¹‰ Gradle properties à¹à¸—à¸™ sed (à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸à¸§à¹ˆà¸²)
    gradle_file = "../app/build.gradle"
    
    begin
      # à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œà¹à¸¥à¸°à¹à¸—à¸™à¸—à¸µà¹ˆ
      gradle_content = File.read(gradle_file)
      
      # Update versionName and versionCode
      gradle_content.gsub!(/versionName\s+"[^"]+"/, "versionName \"#{version_name}\"")
      gradle_content.gsub!(/versionCode\s+\d+/, "versionCode #{version_code}")
      
      # à¹€à¸‚à¸µà¸¢à¸™à¸à¸¥à¸±à¸šà¹„à¸›à¸¢à¸±à¸‡à¹„à¸Ÿà¸¥à¹Œ
      File.write(gradle_file, gradle_content)
      
      # Verify à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡
      updated_content = File.read(gradle_file)
      actual_name = updated_content.match(/versionName "([^"]+)"/)[1]
      actual_code = updated_content.match(/versionCode (\d+)/)[1]
      
      UI.success("âœ… Applied to build.gradle:")
      UI.success("   versionName \"#{actual_name}\"")
      UI.success("   versionCode #{actual_code}")
      
    rescue => e
      UI.error("âŒ Failed to update build.gradle: #{e.message}")
      UI.message("âš ï¸ Falling back to sed command...")
      
      # Fallback à¹ƒà¸Šà¹‰ sed
      sh("sed -i 's/versionName \".*\"/versionName \"#{version_name}\"/' #{gradle_file}")
      sh("sed -i 's/versionCode [0-9]*/versionCode #{version_code}/' #{gradle_file}")
      
      UI.success("âœ… Updated using sed command")
    end
  end

  #à¸ªà¸³à¸«à¸£à¸±à¸š Deployment Internal Testing
  lane :deploy_develop do
    UI.message("ğŸš€ Deploying to Internal Testing...")
    build_and_deploy(
      track: 'internal',
      release_status: 'draft'
    )
  end

  #à¸ªà¸³à¸«à¸£à¸±à¸š Deployment Alpha Testing
  lane :deploy_preprod do
    UI.message("ğŸš€ Deploying to Alpha Testing...")
    build_and_deploy(
      track: 'alpha',
      release_status: 'draft'
    )
  end

  #à¸ªà¸³à¸«à¸£à¸±à¸š Deployment Production
  lane :deploy_master do
    UI.message("ğŸ‰ Deploying to Production...")
    build_and_deploy(
      track: 'production',
      release_status: 'draft',
      rollout: '0.1'  # 10% rollout à¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
    )
  end

  #à¸ªà¸³à¸«à¸£à¸±à¸š Build à¹à¸•à¹ˆà¹„à¸¡à¹ˆ deploy
  lane :build_only do
    UI.message("ğŸ”¨ Building release bundle...")
    gradle(
      task: "clean bundleRelease",
      print_command: false
    )
    UI.success("âœ… Build completed successfully!")
  end

  #Core deployment logic
  private_lane :build_and_deploy do |options|
    # Clean à¹à¸¥à¸° build
    gradle(
      task: "clean bundleRelease",
      print_command: false
    )
    
    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µ AAB file à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    aab_path = "app/build/outputs/bundle/release/app-release.aab"
    unless File.exist?(aab_path)
      UI.user_error!("âŒ AAB file not found at #{aab_path}")
    end
    
    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µ Google Play key à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    json_key_path = "google-play-key.json"
    unless File.exist?(json_key_path)
      UI.user_error!("âŒ Google Play service account key not found at #{json_key_path}")
    end
    
    # Upload to Play Store
    upload_options = {
      track: options[:track],
      json_key: json_key_path,
      aab: aab_path,
      release_status: options[:release_status],
      package_name: "test.cicd.appibc",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      timeout: 300
    }
    
    # à¹€à¸à¸´à¹ˆà¸¡ rollout à¸ªà¸³à¸«à¸£à¸±à¸š production à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
    upload_options[:rollout] = options[:rollout] if options[:rollout]
    
    upload_to_play_store(upload_options)
    
    UI.success("âœ… Successfully uploaded to #{options[:track]} track!")
  end

  #Error handling
  error do |lane, exception|
    error_message = "âŒ Android deployment failed in lane '#{lane}': #{exception.message}"
    UI.error(error_message)
    raise exception
  end
end