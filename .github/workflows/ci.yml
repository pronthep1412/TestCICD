# ci.yml - Manual Platform Testing Control
# ðŸŽ¯ MANUAL PLATFORM TESTING:
# - à¹ƒà¸Šà¹‰ labels à¸«à¸£à¸·à¸­ PR title à¸„à¸§à¸šà¸„à¸¸à¸¡à¸à¸²à¸£ test platform
# - Default: à¹„à¸¡à¹ˆà¸£à¸±à¸™ platform builds (à¸›à¸£à¸°à¸«à¸¢à¸±à¸”à¹€à¸§à¸¥à¸²à¸ªà¸¹à¸‡à¸ªà¸¸à¸”)
# - Manual control: à¹€à¸žà¸´à¹ˆà¸¡ labels à¸«à¸£à¸·à¸­ [Android]/[iOS] à¹ƒà¸™ title
name: Pull Request Testing

on:
  pull_request:
    branches:
      - master
      - develop  
      - preprod
    paths:
      - 'src/**'
      - 'components/**'
      - '__tests__/**'
      - 'test/**'
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'metro.config.js'
      - 'babel.config.js'
      - 'react-native.config.js'
      - 'index.js'
      - 'index.ts'
      - '.env*'
      - '.github/workflows/**'

env:
  NODE_VERSION: 22.11.0
  # ðŸŽ›ï¸ PLATFORM CONTROL VARIABLES - MANUAL CONTROL MODE
  # à¸›à¸£à¸±à¸šà¸„à¹ˆà¸²à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸šà¸„à¸¸à¸¡à¸à¸²à¸£ test platforms
  TEST_ANDROID: 'auto'        # Default: à¸›à¸´à¸” (à¹€à¸›à¸´à¸”à¸”à¹‰à¸§à¸¢ label/title)
  TEST_IOS: 'auto'            # Default: à¸›à¸´à¸” (à¹€à¸›à¸´à¸”à¸”à¹‰à¸§à¸¢ label/title)

jobs:
  
  test-and-validate:
    runs-on: ubuntu-latest
    outputs:
      pr_version: ${{ steps.version.outputs.version }}
      pr_version_code: ${{ steps.version.outputs.version_code }}
      target_branch: ${{ steps.branch.outputs.name }}
      coverage: ${{ steps.coverage.outputs.percentage }}
      test_android: ${{ steps.platforms.outputs.test_android }}
      test_ios: ${{ steps.platforms.outputs.test_ios }}
      
    steps:
      #à¸”à¸¶à¸‡à¹‚à¸„à¹‰à¸”à¹ƒà¸™ git à¸¡à¸²à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥ 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      #à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ node + cache optimization
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      # à¹€à¸žà¸´à¹ˆà¸¡ cache à¸ªà¸³à¸«à¸£à¸±à¸š dependencies à¹€à¸žà¸·à¹ˆà¸­à¸¥à¸”à¹€à¸§à¸¥à¸² install
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/yarn
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      #à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ module install (à¹€à¸£à¹‡à¸§à¸‚à¸¶à¹‰à¸™à¸”à¹‰à¸§à¸¢ cache)
      - name: Install Dependencies
        run: |
          # à¹ƒà¸Šà¹‰ --prefer-offline à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰ cache à¸à¹ˆà¸­à¸™
          yarn install --frozen-lockfile --prefer-offline
          echo "âœ… Dependencies installed: $(du -sh node_modules | cut -f1)"

      #à¸ªà¸£à¹‰à¸²à¸‡ version number à¸­à¸±à¸ž store
      - name: Generate PR Version
        id: version
        run: |
          PR_NUMBER=${{ github.event.number }}
          BASE_VERSION=$(node -p "require('./package.json').version")
          PR_VERSION="$BASE_VERSION-pr.$PR_NUMBER"
          # âœ… Flutter style: Consistent version code for PR testing
          PR_VERSION_CODE=99
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$PR_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ PR Version: $PR_VERSION (code: $PR_VERSION_CODE)"

      #à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¹ˆà¸² PR à¸™à¸µà¹‰à¸ˆà¸° merge à¹€à¸‚à¹‰à¸² branch à¹„à¸«à¸™
      - name: Set Target Branch  
        id: branch
        run: |
          TARGET_BRANCH=${{ github.base_ref }}
          echo "name=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "Target branch: $TARGET_BRANCH"

      # ðŸŽ¯ MANUAL PLATFORM DETECTION
      - name: Detect Required Platforms
        id: platforms
        run: |
          # à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢à¸„à¹ˆà¸² default
          TEST_ANDROID="${{ env.TEST_ANDROID }}"
          TEST_IOS="${{ env.TEST_IOS }}"
          
          echo "ðŸ” Initial platform settings:"
          echo "  TEST_ANDROID: $TEST_ANDROID"
          echo "  TEST_IOS: $TEST_IOS"
          
          # ðŸŽ¯ Manual Control Only - à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ˆà¸²à¸ labels à¹à¸¥à¸° PR title
          
          # Check PR labels
          if echo "${{ github.event.pull_request.labels.*.name }}" | grep -i "test-android" > /dev/null; then
            echo "ðŸ·ï¸ 'test-android' label detected - enabling Android testing"
            TEST_ANDROID="true"
          fi
          
          if echo "${{ github.event.pull_request.labels.*.name }}" | grep -i "test-ios" > /dev/null; then
            echo "ðŸ·ï¸ 'test-ios' label detected - enabling iOS testing"
            TEST_IOS="true"
          fi
          
          # Check PR title
          if echo "${{ github.event.pull_request.title }}" | grep -E "\[Android\]|\[android\]" > /dev/null; then
            echo "ðŸ“ '[Android]' in PR title - enabling Android testing"
            TEST_ANDROID="true"
          fi
          
          if echo "${{ github.event.pull_request.title }}" | grep -E "\[iOS\]|\[ios\]" > /dev/null; then
            echo "ðŸ“ '[iOS]' in PR title - enabling iOS testing"
            TEST_IOS="true"
          fi
          
          # Output final decisions
          echo "test_android=$TEST_ANDROID" >> $GITHUB_OUTPUT
          echo "test_ios=$TEST_IOS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸŽ¯ Final platform testing decisions:"
          echo "  Android: $TEST_ANDROID"
          echo "  iOS: $TEST_IOS"
          echo "  PR title: ${{ github.event.pull_request.title }}"
          echo "  PR labels: ${{ github.event.pull_request.labels.*.name }}"
          echo "  Mode: Manual Control Only"
          
          # Determine bundle creation
          CREATE_ANDROID_BUNDLE="false"
          CREATE_IOS_BUNDLE="false"
          
          if [ "$TEST_ANDROID" = "true" ]; then
            CREATE_ANDROID_BUNDLE="true"
          fi
          
          if [ "$TEST_IOS" = "true" ]; then
            CREATE_IOS_BUNDLE="true"
          fi
          
          echo "create_android_bundle=$CREATE_ANDROID_BUNDLE" >> $GITHUB_OUTPUT
          echo "create_ios_bundle=$CREATE_IOS_BUNDLE" >> $GITHUB_OUTPUT

      ##################################################
      #à¹€à¸‹à¸•à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™ Quality Gates à¹€à¸žà¸·à¹ˆà¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸¸à¸“à¸ à¸²à¸žà¹‚à¸„à¹‰à¸”à¸à¹ˆà¸­à¸™ merge
      - name: Code Linting
        run: yarn lint

      - name: Type Checking
        run: yarn type-check

      - name: Security Audit
        run: |
          echo "## ðŸ” Security Audit Results" >> $GITHUB_STEP_SUMMARY
          if yarn audit --audit-level moderate --json > audit-results.json 2>/dev/null; then
            echo "âœ… No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security vulnerabilities detected - check logs for details" >> $GITHUB_STEP_SUMMARY
            yarn audit --audit-level moderate || true
          fi
      ##################################################
      ##################################################

      ##################################################
      #à¹€à¸‹à¸•à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™ Testing Pipeline à¹€à¸žà¸·à¹ˆà¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹‚à¸„à¹‰à¸”à¸—à¸³à¸‡à¸²à¸™à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¹à¸¥à¸°à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡à¹€à¸žà¸µà¸¢à¸‡à¹ƒà¸”
      - name: Unit & Integration Tests with Coverage
        run: yarn test:ci

      - name: Extract Coverage Percentage
        id: coverage
        run: |
          COVERAGE="0"
          
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "
              try {
                const summary = JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json'));
                summary.total.lines.pct || 0;
              } catch(e) { 0; }
            " 2>/dev/null || echo "0")
          fi
          
          # Validate à¹à¸¥à¸° fallback
          if ! echo "$COVERAGE" | grep -q '^[0-9]*\.*[0-9]*$'; then
            COVERAGE="0"
          fi
          
          if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "" ]; then
            COVERAGE="0"
          fi
          
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"
      ##################################################
      ##################################################

      ##################################################
      #à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥ + à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ coverage
      - name: Coverage Report
        run: |
          echo "## ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          COVERAGE="${{ steps.coverage.outputs.percentage }}"
          echo "- **Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "coverage" ]; then
            echo "- **Detailed Report:** Available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Detailed Report:** No coverage files generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$COVERAGE" = "0" ]; then
            echo "- **â„¹ï¸ Info:** No unit tests found - consider adding tests for better code quality" >> $GITHUB_STEP_SUMMARY
          elif [ "$(awk "BEGIN {print ($COVERAGE >= 70) ? 1 : 0}")" = "1" ]; then
            echo "- **âœ… Good:** Coverage meets recommended threshold (â‰¥70%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **âš ï¸ Warning:** Coverage below 70% recommended threshold" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.event.number }}
          path: |
            coverage/
            jest-coverage/
          retention-days: 7
      ##################################################
      ##################################################

      ##################################################
      #à¹€à¸­à¸²à¹„à¸§à¹‰à¸ªà¸£à¹‰à¸²à¸‡ JavaScript bundles à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ (Dynamic Bundle Creation)
      - name: Create JS Bundles for Sharing
        run: |
          echo "ðŸ“¦ Creating JavaScript bundles based on platform requirements..."
          
          ANDROID_NEEDED="${{ steps.platforms.outputs.create_android_bundle }}"
          IOS_NEEDED="${{ steps.platforms.outputs.create_ios_bundle }}"
          
          echo "Bundle creation plan:"
          echo "  Android bundle: $ANDROID_NEEDED"
          echo "  iOS bundle: $IOS_NEEDED"
          
          # Create Android bundle if needed
          if [ "$ANDROID_NEEDED" = "true" ]; then
            echo "ðŸ¤– Creating Android bundle..."
            mkdir -p bundles/android
            npx react-native bundle \
              --platform android \
              --dev false \
              --entry-file index.js \
              --bundle-output bundles/android/index.android.bundle \
              --assets-dest bundles/android/assets/ \
              --minify true
            echo "âœ… Android bundle created"
          else
            echo "â­ï¸ Skipping Android bundle creation"
          fi
          
          # Create iOS bundle if needed  
          if [ "$IOS_NEEDED" = "true" ]; then
            echo "ðŸ“± Creating iOS bundle..."
            mkdir -p bundles/ios
            npx react-native bundle \
              --platform ios \
              --dev false \
              --entry-file index.js \
              --bundle-output bundles/ios/main.jsbundle \
              --assets-dest bundles/ios/assets/ \
              --minify true
            echo "âœ… iOS bundle created"
          else
            echo "â­ï¸ Skipping iOS bundle creation"
          fi
          
          echo "ðŸŽ¯ Bundle creation completed based on platform requirements"

      - name: Upload Android Bundle
        if: steps.platforms.outputs.create_android_bundle == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: js-bundle-android-${{ github.run_number }}
          path: bundles/android/
          retention-days: 1

      - name: Upload iOS Bundle
        if: steps.platforms.outputs.create_ios_bundle == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: js-bundle-ios-${{ github.run_number }}
          path: bundles/ios/
          retention-days: 1
      ##################################################
      ##################################################

  
  # ðŸ¤– CONDITIONAL ANDROID BUILD
  # à¸£à¸±à¸™à¹€à¸‰à¸žà¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­ platform detection à¸à¸³à¸«à¸™à¸”à¹ƒà¸«à¹‰ test Android
  build-android-test:
    needs: test-and-validate
    if: needs.test-and-validate.outputs.test_android == 'true'
    uses: ./.github/workflows/android-build.yml
    with:
      environment: debug
      publish: false
      version: ${{ needs.test-and-validate.outputs.pr_version }}
      version_code: ${{ needs.test-and-validate.outputs.pr_version_code }}
      branch: ${{ needs.test-and-validate.outputs.target_branch }}
      js_bundle_artifact: js-bundle-android-${{ github.run_number }}
    secrets: inherit

  # ï¿½ CONDITIONAL iOS BUILD  
  # à¸£à¸±à¸™à¹€à¸‰à¸žà¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­ platform detection à¸à¸³à¸«à¸™à¸”à¹ƒà¸«à¹‰ test iOS
  build-ios-test:
    needs: test-and-validate
    if: needs.test-and-validate.outputs.test_ios == 'true'
    uses: ./.github/workflows/ios-build.yml
    with:
      environment: debug
      publish: false
      version: ${{ needs.test-and-validate.outputs.pr_version }}
      version_code: ${{ needs.test-and-validate.outputs.pr_version_code }}
      branch: ${{ needs.test-and-validate.outputs.target_branch }}
      js_bundle_artifact: js-bundle-ios-${{ github.run_number }}
    secrets: inherit

  #à¸ªà¸£à¸¸à¸›à¸à¸²à¸£ build test - Smart summary based on tested platforms
  pr-summary:
    needs: [test-and-validate, build-android-test, build-ios-test]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: PR Summary
        run: |
          echo "## ðŸš€ Pull Request Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Version:** ${{ needs.test-and-validate.outputs.pr_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage:** ${{ needs.test-and-validate.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          
          # Platform testing summary
          ANDROID_TESTED="${{ needs.test-and-validate.outputs.test_android }}"
          IOS_TESTED="${{ needs.test-and-validate.outputs.test_ios }}"
          
          echo "- **Platform Testing:**" >> $GITHUB_STEP_SUMMARY
          if [ "$ANDROID_TESTED" = "true" ] && [ "$IOS_TESTED" = "true" ]; then
            echo "  - ðŸŽ¯ Full testing: Both Android & iOS" >> $GITHUB_STEP_SUMMARY
          elif [ "$ANDROID_TESTED" = "true" ] && [ "$IOS_TESTED" = "false" ]; then
            echo "  - ðŸ¤– Android only (iOS will test in CD)" >> $GITHUB_STEP_SUMMARY
          elif [ "$ANDROID_TESTED" = "false" ] && [ "$IOS_TESTED" = "true" ]; then
            echo "  - ðŸ“± iOS only (Android will test in CD)" >> $GITHUB_STEP_SUMMARY
          else
            echo "  - âš ï¸ No platform builds (check configuration)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status check with platform-aware logic
          TESTS_PASSED="${{ needs.test-and-validate.result }}"
          ANDROID_RESULT="${{ needs.build-android-test.result }}"
          IOS_RESULT="${{ needs.build-ios-test.result }}"
          
          OVERALL_SUCCESS="true"
          ISSUES=()
          
          # Check test results
          if [ "$TESTS_PASSED" != "success" ]; then
            OVERALL_SUCCESS="false"
            ISSUES+=("Fix test failures")
          fi
          
          # Check Android build if it was supposed to run
          if [ "$ANDROID_TESTED" = "true" ] && [ "$ANDROID_RESULT" != "success" ] && [ "$ANDROID_RESULT" != "skipped" ]; then
            OVERALL_SUCCESS="false" 
            ISSUES+=("Fix Android build issues")
          fi
          
          # Check iOS build if it was supposed to run
          if [ "$IOS_TESTED" = "true" ] && [ "$IOS_RESULT" != "success" ] && [ "$IOS_RESULT" != "skipped" ]; then
            OVERALL_SUCCESS="false"
            ISSUES+=("Fix iOS build issues")
          fi
          
          # Generate final summary
          if [ "$OVERALL_SUCCESS" = "true" ]; then
            echo "### âœ… Ready for Merge" >> $GITHUB_STEP_SUMMARY
            echo "- All required tests and builds completed successfully" >> $GITHUB_STEP_SUMMARY
            
            # Show what will happen after merge
            if [ "$ANDROID_TESTED" = "false" ] || [ "$IOS_TESTED" = "false" ]; then
              echo "- Untested platforms will build automatically in CD pipeline" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Issues Found" >> $GITHUB_STEP_SUMMARY
            for issue in "${ISSUES[@]}"; do
              echo "- $issue" >> $GITHUB_STEP_SUMMARY
            done
          fi
          
          # Platform control hints
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Platform Control Tips" >> $GITHUB_STEP_SUMMARY
          echo "- Use \`[iOS]\` in PR title to force iOS testing" >> $GITHUB_STEP_SUMMARY
          echo "- Use \`[Android]\` in PR title to force Android testing" >> $GITHUB_STEP_SUMMARY  
          echo "- Add labels: \`test-ios\` or \`test-android\` for manual control" >> $GITHUB_STEP_SUMMARY
          echo "- Manual control only - no auto-detection" >> $GITHUB_STEP_SUMMARY
          
# ðŸ“‹ USAGE EXAMPLES:
# 
# 1. Default (fastest, recommended):
#    - No labels, no [Platform] in title
#    - Only tests will run (~1-2 minutes)
#    - Platform builds skipped to save time
#
# 2. Android-only testing:
#    - Add [Android] to PR title
#    - Or add 'test-android' label
#    - Or set TEST_ANDROID: 'true'
#    - Only Android build will run (~3-5 minutes)
#
# 3. iOS-only testing:
#    - Add [iOS] to PR title
#    - Or add 'test-ios' label  
#    - Or set TEST_IOS: 'true'
#    - Only iOS build will run (~8-10 minutes)
#
# 4. Full testing (both platforms):
#    - Add both 'test-ios' and 'test-android' labels
#    - Or add both [Android] and [iOS] to title
#    - Or set both TEST_ANDROID: 'true', TEST_IOS: 'true'
#    - Both builds will run (~12-15 minutes)
#
# 5. Force override via environment:
#    - Set TEST_ANDROID: 'true', TEST_IOS: 'false'
#    - Ignores labels and title completely