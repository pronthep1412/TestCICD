# .github/workflows/ios-build.yml - Optimized version with redundancy reduction
name: "iOS Build and Deploy"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      publish:
        required: false
        type: boolean
        default: false
      version:
        required: true
        type: string
      version_code:
        required: true
        type: string
      branch:
        required: true
        type: string
      js_bundle_artifact:
        description: 'Pre-built JavaScript bundle artifact name'
        required: false
        type: string
        default: ''
    secrets:
      APPLE_ID:
        required: true
      APPLE_ID_PASSWORD:
        required: true
      APP_STORE_CONNECT_API_KEY_ID:
        required: true
      APP_STORE_CONNECT_API_ISSUER_ID:
        required: true
      APP_STORE_CONNECT_API_KEY:
        required: true
      MATCH_PASSWORD:
        required: true
      MATCH_GIT_URL:
        required: true
      MATCH_PRIVATE_KEY:
        required: false
      NPM_TOKEN:
        required: true

env:
  NODE_VERSION: 22.11.0
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  build-ios:
    runs-on: macos-15
    timeout-minutes: 30
    
    #‡∏Å‡∏≥‡∏´‡∏ô‡∏î GitHub Environment ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ deploy
    environment: 
      name: ${{ inputs.branch == 'master' && 'production' || inputs.branch }}
    
    steps:
      #‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô git ‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• 
      - name: Checkout Repository
        uses: actions/checkout@v4 

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á node
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á module install
      - name: Install Node Dependencies
        run: yarn install --frozen-lockfile

      #‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JavaScript bundle ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å build ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
      - name: Download Pre-built JS Bundle
        if: inputs.js_bundle_artifact != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.js_bundle_artifact }}
          path: ./js-bundle/

      #‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° JavaScript bundle ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ build ‡πÉ‡∏´‡∏°‡πà
      - name: Setup JS Bundle for iOS
        run: |
          mkdir -p ios/bundle
          
          if [ "${{ inputs.js_bundle_artifact }}" != "" ] && [ -f "./js-bundle/main.jsbundle" ]; then
            # Use pre-built iOS bundle
            cp ./js-bundle/main.jsbundle ios/bundle/
            if [ -d "./js-bundle/assets" ]; then
              cp -r ./js-bundle/assets/* ios/bundle/ 2>/dev/null || true
            fi
            echo "‚úÖ Using pre-built iOS JS bundle"
          else
            # Create new iOS bundle (node_modules is available)
            echo "üîÑ Creating fresh iOS JS bundle..."
            npx react-native bundle \
              --platform ios \
              --dev false \
              --entry-file index.js \
              --bundle-output ios/bundle/main.jsbundle \
              --assets-dest ios/bundle/ \
              --minify true
            echo "‚úÖ Fresh iOS JS bundle created"
          fi
          
          # Verify bundle
          if [ -f "ios/bundle/main.jsbundle" ]; then
            bundle_size=$(ls -lh ios/bundle/main.jsbundle | awk '{print $5}')
            echo "üì¶ iOS JS bundle ready: $bundle_size"
          else
            echo "‚ùå iOS JS bundle missing!"
            exit 1
          fi

      #‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Ruby environment ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Fastlane
      - name: Setup Ruby for Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios

      #‡∏£‡∏±‡∏ô pod install
      - name: Install CocoaPods Dependencies
        run: |
          cd ios
          echo "üì± Installing CocoaPods dependencies..."
          
          # Check if cache hit
          if [ -d "Pods" ] && [ -f "Podfile.lock" ]; then
            echo "‚úÖ Pods cache found, verifying integrity..."
            pod install --deployment 2>/dev/null || {
              echo "‚ö†Ô∏è Cache invalid, reinstalling..."
              rm -rf Pods Podfile.lock
              pod install
            }
          else
            echo "üîÑ Installing fresh Pods..."
            pod install
          fi
          
          # Post-install verification
          if [ -d "Pods" ]; then
            pod_count=$(find Pods -name "*.podspec" | wc -l)
            echo "‚úÖ CocoaPods installation completed: $pod_count pods"
          else
            echo "‚ùå CocoaPods installation failed!"
            exit 1
          fi

      #Select Xcode Version, Clear Derived Data, Verification & Logging
      - name: Setup Xcode Environment
        run: |
          # Ensure we're using the default Xcode
          sudo xcode-select -s /Applications/Xcode.app
          
          # Clear any derived data issues
          rm -rf ~/Library/Developer/Xcode/DerivedData/TestCICD-*
          
          # Verify setup
          echo "‚úÖ Xcode setup completed:"
          echo "- Selected: $(xcode-select -p)"
          echo "- Version: $(xcodebuild -version)"
          echo "- SDKs: $(xcodebuild -showsdks | grep iOS | tail -1)"

      #‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SSH authentication ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Match repository
      - name: Setup SSH for Match
        if: inputs.environment == 'release'
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.MATCH_PRIVATE_KEY }}
        continue-on-error: true

      #‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API authentication ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö App Store Connect ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö deploy iOS app
      - name: Setup App Store Connect API
        if: inputs.environment == 'release'
        run: |
          mkdir -p /tmp/ios-keys
          
          # Check if API key is provided and setup
          if [ -n "${{ secrets.APP_STORE_CONNECT_API_KEY }}" ]; then
            echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d > /tmp/ios-keys/AuthKey.p8
            
            # Verify API key
            if [ -f "/tmp/ios-keys/AuthKey.p8" ]; then
              key_size=$(ls -lh /tmp/ios-keys/AuthKey.p8 | awk '{print $5}')
              echo "‚úÖ App Store Connect API key ready: $key_size"
            else
              echo "‚ùå API key creation failed!"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è No App Store Connect API key provided - some deployment features may not work"
          fi

      #build iOS app ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î debug ‡πÄ‡∏°‡∏∑‡πà‡∏≠ environment ‡πÄ‡∏õ‡πá‡∏ô debug
      - name: Build iOS Debug
        if: inputs.environment == 'debug'
        run: |
          cd ios
          echo "üî® Building iOS Debug..."
          
          # Pre-build validation
          echo "üìã Pre-build checks:"
          echo "- Workspace: $(ls -la *.xcworkspace)"
          echo "- Scheme available: $(xcodebuild -workspace TestCICD.xcworkspace -list | grep TestCICD)"
          echo "- Simulators: $(xcrun simctl list devices available | grep iPhone | head -3)"
          
          # Build with enhanced settings
          set -o pipefail
          xcodebuild -workspace TestCICD.xcworkspace \
                    -scheme TestCICD \
                    -configuration Debug \
                    -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
                    -derivedDataPath ./DerivedData \
                    -allowProvisioningUpdates \
                    clean build | tee build.log
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ iOS Debug build completed successfully"
            
            # Build summary
            if [ -f "build.log" ]; then
              build_time=$(grep "BUILD SUCCEEDED" build.log | tail -1 || echo "Build time not found")
              echo "‚è±Ô∏è $build_time"
            fi
          else
            echo "‚ùå iOS Debug build failed"
            echo "üìÑ Last 30 lines of build log:"
            tail -30 build.log
            exit 1
          fi

      #build iOS app ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î release ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà deploy ‡πÑ‡∏õ‡∏¢‡∏±‡∏á App Store
      - name: Build iOS Release (No Deploy)
        if: inputs.environment == 'release' && inputs.publish == false
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          VERSION_NUMBER: ${{ inputs.version }}
          BUILD_NUMBER: ${{ inputs.version_code }}
          VERSION_NAME: ${{ inputs.version }}
          VERSION_CODE: ${{ inputs.version_code }}
          SKIP_AUTO_VERSION: "true"
        run: |
          cd ios
          echo "üî® Building iOS Release (No Deploy)..."
          
          # Pre-build setup
          echo "üìã Release build configuration:"
          echo "- Version: $VERSION_NUMBER"
          echo "- Build: $BUILD_NUMBER"
          echo "- Match URL configured: $([ -n "$MATCH_GIT_URL" ] && echo "Yes" || echo "No")"
          
          # Build with Fastlane
          if bundle exec fastlane build_only; then
            echo "‚úÖ iOS Release build completed successfully"
            
            # Find and report built artifacts
            if [ -d "build" ]; then
              echo "üì¶ Build artifacts:"
              ls -la build/*.ipa 2>/dev/null || echo "No IPA files found"
              
              # Report sizes
              for ipa in build/*.ipa; do
                if [ -f "$ipa" ]; then
                  ipa_size=$(ls -lh "$ipa" | awk '{print $5}')
                  echo "- $(basename "$ipa"): $ipa_size"
                fi
              done
            fi
          else
            echo "‚ùå iOS Release build failed"
            echo "üîç Checking Fastlane logs..."
            ls -la fastlane/logs/ 2>/dev/null || echo "No Fastlane logs found"
            exit 1
          fi

      #build iOS app ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î release ‡πÅ‡∏•‡∏∞ deploy ‡πÑ‡∏õ‡∏¢‡∏±‡∏á App Store
      - name: Build and Deploy to TestFlight/App Store
        if: inputs.environment == 'release' && inputs.publish == true
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_API_KEY_PATH: /tmp/ios-keys/AuthKey.p8
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          VERSION_NUMBER: ${{ inputs.version }}
          BUILD_NUMBER: ${{ github.run_number }}
          VERSION_NAME: ${{ inputs.version }}
          VERSION_CODE: ${{ inputs.version_code }}
          SKIP_AUTO_VERSION: "true"
        run: |
          cd ios
          echo "üöÄ Building and deploying iOS to App Store Connect..."
          
          # Pre-deploy validation
          echo "üìã Deployment configuration:"
          echo "- Target: ${{ inputs.branch }}"
          echo "- Version: $VERSION_NUMBER"
          echo "- Build: $BUILD_NUMBER"
          echo "- API Key ID: ${APP_STORE_CONNECT_API_KEY_ID:0:8}..."
          echo "- API Key file: $([ -f "$APP_STORE_CONNECT_API_KEY_PATH" ] && echo "Ready" || echo "Missing")"
          
          # Determine deployment track
          TRACK="TestFlight Internal"
          case "${{ inputs.branch }}" in
            "master") TRACK="App Store" ;;
            "preprod") TRACK="TestFlight Beta" ;;
          esac
          echo "- Deployment track: $TRACK"
          
          # Deploy with Fastlane
          if bundle exec fastlane deploy_${{ inputs.branch }}; then
            echo "‚úÖ iOS deployment to $TRACK completed successfully"
          else
            echo "‚ùå iOS deployment failed"
            echo "üîç Fastlane logs:"
            find fastlane/logs -name "*.log" -exec echo "=== {} ===" \; -exec tail -50 {} \; 2>/dev/null || echo "No Fastlane logs found"
            exit 1
          fi

      #‡πÄ‡∏Å‡πá‡∏ö iOS build outputs ‡πÄ‡∏õ‡πá‡∏ô artifacts ‡πÄ‡∏°‡∏∑‡πà‡∏≠ build release ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà deploy
      - name: Upload iOS Build Artifacts
        if: inputs.publish == false && inputs.environment == 'release'
        uses: actions/upload-artifact@v4  # üîÑ Updated from v3
        with:
          name: ios-${{ inputs.environment }}-${{ inputs.version }}-${{ github.run_number }}
          path: |
            ios/build/*.ipa
            ios/build/*.dSYM.zip
            ios/build.log
            ios/fastlane/logs/*.log
          retention-days: 7
          compression-level: 6

      #‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£ build 
      - name: Generate Build Summary
        if: always()
        run: |
          echo "## üçé iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ inputs.version_code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner:** ${{ runner.os }} ($(sw_vers -productVersion))" >> $GITHUB_STEP_SUMMARY
          echo "- **Xcode:** $(xcodebuild -version | head -1)" >> $GITHUB_STEP_SUMMARY
          
          # Build status
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **Build Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Build Status:** ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # File sizes and details
          if [ -d "ios/build" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üì¶ Build Artifacts" >> $GITHUB_STEP_SUMMARY
            
            for ipa in ios/build/*.ipa; do
              if [ -f "$ipa" ]; then
                ipa_name=$(basename "$ipa")
                ipa_size=$(ls -lh "$ipa" | awk '{print $5}')
                echo "- **$ipa_name:** $ipa_size" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            # dSYM files
            for dsym in ios/build/*.dSYM.zip; do
              if [ -f "$dsym" ]; then
                dsym_name=$(basename "$dsym")
                dsym_size=$(ls -lh "$dsym" | awk '{print $5}')
                echo "- **$dsym_name:** $dsym_size" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
          
          # Deployment info
          if [ "${{ inputs.publish }}" = "true" ]; then
            TRACK="TestFlight Internal"
            case "${{ inputs.branch }}" in
              "master") TRACK="App Store" ;;
              "preprod") TRACK="TestFlight Beta" ;;
            esac
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üöÄ Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- **Target:** $TRACK" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** ‚úÖ Deployed successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.environment }}" = "release" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìÅ Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** Available for download" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Performance metrics
          if [ -f "ios/build.log" ]; then
            if grep -q "BUILD SUCCEEDED" ios/build.log; then
              build_time=$(grep "BUILD SUCCEEDED" ios/build.log | tail -1 | grep -o '[0-9]*\.[0-9]*s' || echo "Unknown")
              if [ "$build_time" != "Unknown" ]; then
                echo "- **Build Time:** $build_time" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Build completed on $(date)*" >> $GITHUB_STEP_SUMMARY

      #‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏±‡∏ö ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å build/deploy ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
      - name: Cleanup Sensitive Files
        if: always()
        run: |
          rm -rf /tmp/ios-keys
          rm -f ios/google-play-key.json 2>/dev/null || true
          
          # Clean up Fastlane temporary files
          rm -rf ios/fastlane/tmp 2>/dev/null || true
          
          echo "‚úÖ Sensitive files cleaned up"